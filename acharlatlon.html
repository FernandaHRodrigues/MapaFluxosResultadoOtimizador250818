<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Coordenadas em Lote</title>
    <style>
        body { 
            font-family: system-ui, sans-serif;
            padding: 20px;
            background-color: #f7f7f7;
        }
        #container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h3 { color: #333; }
        #status {
            margin: 20px 0;
            padding: 10px;
            font-style: italic;
            font-weight: bold;
            color: #0056b3;
            background-color: #f0f7ff;
            border-left: 5px solid #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr.not-found td { background-color: #fff0f0; color: #d8000c; }
        .download-section { margin-top: 25px; text-align: center; }
        .download-button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        .download-button:disabled {
            background-color: #9c9c9c;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Buscador de Coordenadas</h1>
        <h3 id="status">Iniciando...</h3>
        
        <table>
            <thead>
                <tr>
                    <th>Cidade</th>
                    <th>País</th>
                    <th>Latitude</th>
                    <th>Longitude</th>
                </tr>
            </thead>
            <tbody id="results-table">
                </tbody>
        </table>

        <div class="download-section">
            <button id="download-csv" class="download-button" disabled>Baixar como CSV (Excel)</button>
            <button id="download-txt" class="download-button" disabled>Baixar como TXT</button>
        </div>
    </div>

    <script>
        // Lista de locais extraída da sua pergunta
        const locations = [
            "SANTO DOMINGO, República Dominicana", "Ottawa, Canadá", "Washington, EUA",
            "Cidade do México, México", "Buenos Aires, Argentina", "COCHABAMBA, Bolívia",
            "Sucre, Bolívia", "SANTIAGO, Chile", "Santiago, Chile", "BARRANQUILLA, Colombia",
            "GUAYAQUIL, Equador", "Quito, Equador", "LIMA, Peru", "Assunção, Paraguai",
            "Montevidéu, Uruguai", "Caracas, Venezuela", "Pequim, China", "Pyongyang, Coréia do Sul",
            "Bangkok, Tailândia", "Ancara, Turquia", "Bruxelas, Bélgica", "Berlim, Alemanha",
            "Madrid, Espanha", "Paris, França", "Amsterdã, Holanda", "HAMILTON, Canadá",
            "MOBILE, EUA", "FONTANA, EUA", "LÁZARO CÁRDENAS, Mexico", "SAN NICOLAS DE LOS GARZA, Mexico",
            "ALVEAR, Argentina", "CORDOBA, Argentina", "TALCAHUANO, Chile", "BOGOTA, Colombia",
            "BANGSAPHAN, Tailândia", "ISTAMBUL, Turquia", "Luanda, Angola", "Yamoussoukro, Costa do Marfim",
            "Rabat, Marrocos", "Pretória, África do Sul", "PORT COLBORNE, Canadá", "LOS ANGELES, EUA",
            "ALTAMIRA TAMAULIPAS, Mexico", "VALPARAISO, Chile", "EL CALLAO, Peru", "PARACAS, Peru",
            "LA GUAIRA, Venezuela", "Abu Dhabi, Emirados Árabes Unidos", "XANGAI, China",
            "Nova Delhi, Índia", "Singapura, Singapura", "BANGKOK, Tailândia"
        ];
        
        const uniqueLocations = [...new Set(locations)];

        const statusDiv = document.getElementById('status');
        const resultsTable = document.getElementById('results-table');
        const downloadCsvButton = document.getElementById('download-csv');
        const downloadTxtButton = document.getElementById('download-txt');
        
        let searchResults = [];

        function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

        async function fetchAllCoordinates() {
            const total = uniqueLocations.length;
            
            for (let i = 0; i < total; i++) {
                const query = uniqueLocations[i];
                statusDiv.textContent = `Buscando (${i + 1}/${total}): ${query}`;
                
                const result = {
                    city: query.split(',')[0].trim(),
                    country: query.split(',')[1]?.trim() || '',
                    lat: 'Não encontrada',
                    lon: 'Não encontrada',
                    found: false
                };

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        result.lat = parseFloat(data[0].lat).toFixed(4);
                        result.lon = parseFloat(data[0].lon).toFixed(4);
                        result.found = true;
                    }
                } catch (error) {
                    console.error(`Erro ao buscar ${query}:`, error);
                }
                
                searchResults.push(result);
                updateTable(result);
                await sleep(1000);
            }
            
            statusDiv.textContent = 'Processo concluído!';
            downloadCsvButton.disabled = false;
            downloadTxtButton.disabled = false;
        }

        function updateTable(result) {
            const newRow = resultsTable.insertRow();
            newRow.className = result.found ? 'found' : 'not-found';
            
            // Troca o ponto pela vírgula para exibição na tabela
            const latDisplay = String(result.lat).replace('.', ',');
            const lonDisplay = String(result.lon).replace('.', ',');
            
            newRow.innerHTML = `<td>${result.city}</td><td>${result.country}</td><td>${latDisplay}</td><td>${lonDisplay}</td>`;
        }
        
        function downloadFile(format) {
            // Usa ponto e vírgula (;) como separador para melhor compatibilidade com Excel em português
            let content = 'Cidade;País;Latitude;Longitude\n';
            
            searchResults.forEach(res => {
                // --- MUDANÇA PRINCIPAL AQUI ---
                // Troca o ponto do número por uma vírgula para o arquivo de download
                const latStr = String(res.lat).replace('.', ',');
                const lonStr = String(res.lon).replace('.', ',');
                
                content += `"${res.city}";"${res.country}";"${latStr}";"${lonStr}"\n`;
            });
            
            const mimeType = format === 'csv' ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;';
            const filename = `coordenadas.${format}`;
            
            // Adiciona um BOM para o Excel entender a codificação UTF-8 corretamente
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, content], { type: mimeType });
            
            const link = document.createElement("a");
            
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        downloadCsvButton.addEventListener('click', () => downloadFile('csv'));
        downloadTxtButton.addEventListener('click', () => downloadFile('txt'));
        
        window.onload = fetchAllCoordinates;
    </script>

</body>
</html>